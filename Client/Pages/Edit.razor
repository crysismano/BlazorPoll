@page "/edit/{pollId:int}"

@inject IPollService PollService
@inject NavigationManager NavigationManager 

<PollEditor Poll="Poll" Questions="Questions" Answers="Answers" Title="Edit" HandleSubmit="HandleSubmit" />

@code {
    [Parameter] public int PollId { get; set; }
    public Poll Poll { get; set; } = new Poll();
    public List<Question> Questions { get; set; } = new List<Question>();
    public List<List<Answer>> Answers { get; set; } = new List<List<Answer>>();

    protected override async Task OnInitializedAsync()
    {
        Poll = await PollService.GetPoll(PollId);
        Questions = Poll.Questions.ToList();
        for(int i = 0; i < Questions.Count; i++)
        {
            Answers.Add(Questions[i].Answers.ToList());
        }
    }

    async Task HandleSubmit()
    {
        if (Poll.Name is null || Poll.Name == "")
            return;
        List<Question> questions = Questions.Where(x => x.Text != "").ToList();
        if (questions.Count == 0)
            return;
        questions = Questions;
        for (int j = 0; j < questions.Count; j++)
        {
            var answers = new List<Answer>();
            answers = Answers[j].Where(x => x.Text != "").ToList();
            if (answers.Count == 0 && questions[j].Text != "")
                return;
            questions[j].Answers = answers;
        }
        questions = questions.Where(x => x.Text != "").ToList();
        Poll.Questions = questions;
        await PollService.UpdatePoll(Poll);
        NavigationManager.NavigateTo($"/");
    }
}
